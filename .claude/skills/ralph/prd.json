{
  "project": "obsidian-workout-plugin",
  "branchName": "ralph/custom-muscle-tag-mapping",
  "description": "Custom Muscle Tag Mapping System - Allow users to create custom muscle tags in any language and map them to canonical muscle groups via CSV file with fuzzy matching suggestions.",
  "userStories": [
    {
      "id": "US-001",
      "title": "Create MuscleTagService with CSV read/write",
      "description": "As a developer, I need a service to read and write the muscle tags CSV file with caching and fallback to defaults.",
      "acceptanceCriteria": [
        "Create `app/services/MuscleTagService.ts` as singleton service",
        "CSV structure: `tag,muscleGroup` (e.g., `petto,chest`)",
        "Implement `loadTags(): Promise<Map<string, string>>` - reads CSV, returns tag->muscleGroup map",
        "Implement `saveTags(tags: Map<string, string>): Promise<void>` - writes CSV",
        "Implement `getTagMap(): Map<string, string>` - returns cached tags or default MUSCLE_TAG_MAP",
        "CSV path: same folder as settings.dataFilePath with filename `muscle-tags.csv`",
        "Cache tags with invalidation when file changes (use vault.on('modify'))",
        "Fallback to MUSCLE_TAG_MAP from muscles.constants.ts if CSV doesn't exist",
        "Handle malformed CSV gracefully (skip invalid rows, log warning)",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Implemented MuscleTagService with all required methods. Uses vault.on('modify') for cache invalidation. Includes helper methods: csvExists(), createDefaultCsv(), getCsvPath(), getTagMapAsObject(). Service needs destroy() call on plugin unload."
    },
    {
      "id": "US-002",
      "title": "Add unit tests for MuscleTagService",
      "description": "As a developer, I want unit tests for MuscleTagService to ensure it works correctly.",
      "acceptanceCriteria": [
        "Create `app/services/__tests__/MuscleTagService.test.ts`",
        "Test loadTags parses valid CSV correctly",
        "Test loadTags returns default tags when CSV doesn't exist",
        "Test loadTags handles malformed CSV rows gracefully",
        "Test saveTags writes correct CSV format",
        "Test getTagMap returns cached data on subsequent calls",
        "Test cache invalidation when file path matches",
        "npm test passes",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Created comprehensive test suite with 35 tests covering: constructor behavior, loadTags (CSV parsing, defaults, malformed rows, quoted values, header handling, concurrent requests), saveTags (format, existing file modification, folder creation, escaping, cache update, error handling), getTagMap (caching, defaults, background loading), getTagMapAsObject, cache invalidation (file modify, different file, manual clear), csvExists, createDefaultCsv, destroy, getCsvPath."
    },
    {
      "id": "US-003",
      "title": "Add Levenshtein distance utility for fuzzy matching",
      "description": "As a developer, I need a Levenshtein distance function for fuzzy tag matching.",
      "acceptanceCriteria": [
        "Add `levenshteinDistance(a: string, b: string): number` to `app/utils/StringUtils.ts`",
        "Function computes edit distance between two strings",
        "Add `findSimilarStrings(needle: string, haystack: string[], maxDistance: number): string[]` helper",
        "Case-insensitive comparison (convert both to lowercase)",
        "Export both functions from StringUtils.ts",
        "Add unit tests in `app/utils/__tests__/StringUtils.test.ts`",
        "Test Levenshtein: 'kitten' vs 'sitting' = 3",
        "Test Levenshtein: 'chest' vs 'chest' = 0",
        "Test findSimilarStrings returns matches within maxDistance",
        "npm test passes",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Created StringUtils.ts as the centralized string matching utility. Contains: (1) getMatchScore() - semantic/heuristic matching moved from ExerciseMatchUtils, (2) levenshteinDistance() - edit distance for typo detection, (3) findSimilarStrings() - fuzzy search helper. ExerciseMatchUtils.getMatchScore() now delegates to StringUtils. 33 unit tests cover both matching approaches."
    },
    {
      "id": "US-004",
      "title": "Integrate MuscleTagService into DataFilter",
      "description": "As a developer, I need DataFilter to use MuscleTagService instead of hardcoded MUSCLE_TAG_MAP.",
      "acceptanceCriteria": [
        "DataFilter constructor accepts MuscleTagService instance",
        "Replace direct MUSCLE_TAG_MAP usage with service.getTagMap()",
        "Update CodeBlockProcessorService to pass service to DataFilter",
        "Existing tests continue to pass (may need mock service)",
        "Typecheck passes",
        "npm test passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Implemented via static service pattern for backward compatibility. MuscleTagService initialized in main.ts and passed to CodeBlockProcessorService. DataFilter has static setMuscleTagService(), getMuscleTagService(), getTagMap(), and clearMuscleTagService() methods. Service set during CodeBlockProcessorService construction and cleared on plugin unload. Note: DataFilter didn't use MUSCLE_TAG_MAP directly - the integration prepares DataFilter to expose the custom tag map for components that need it (like MuscleTagMapper in US-005)."
    },
    {
      "id": "US-005",
      "title": "Integrate MuscleTagService into MuscleHeatMap",
      "description": "As a developer, I need MuscleHeatMap to use MuscleTagService for muscle group lookups.",
      "acceptanceCriteria": [
        "MuscleHeatMap component accepts MuscleTagService or tag map",
        "Replace direct MUSCLE_TAG_MAP usage with service.getTagMap()",
        "Update EmbeddedDashboardView to pass service to MuscleHeatMap",
        "Heatmap still renders correctly with custom tags",
        "Typecheck passes",
        "npm test passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": "Updated MuscleTagMapper.ts to use DataFilter.getTagMap() instead of CONSTANTS.WORKOUT.MUSCLES.TAG_MAP. Added private getTagMap() helper that returns custom tags from MuscleTagService via DataFilter when available, falling back to default MUSCLE_TAG_MAP. No changes needed to EmbeddedDashboardView since MuscleTagMapper accesses the service via DataFilter's static methods (set in US-004)."
    },
    {
      "id": "US-006",
      "title": "Add settings button to create default tag CSV",
      "description": "As a user, I want a button in settings to create the muscle tags CSV with default values.",
      "acceptanceCriteria": [
        "Add 'Create muscle tags CSV' button in WorkoutChartsSettingTab",
        "Button calls MuscleTagService to create CSV with all MUSCLE_TAG_MAP defaults",
        "If file exists, show confirmation modal before overwriting",
        "Show success Notice on creation",
        "Show error Notice if creation fails",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 6,
      "passes": true,
      "notes": "Added 'Create muscle tags' button in GeneralSettings.ts under CSV Management section. Button uses MuscleTagService.createDefaultCsv() for new files and MuscleTagService.saveTags() with defaults for overwrites. Shows ConfirmModal before overwriting existing files. Displays success/error notices. Added UI constants: LABELS.CREATE_MUSCLE_TAGS_CSV, DESCRIPTIONS.CREATE_MUSCLE_TAGS_CSV, DESCRIPTIONS.CONFIRM_OVERWRITE_MUSCLE_TAGS, BUTTONS.CREATE_MUSCLE_TAGS, SUCCESS.MUSCLE_TAGS_CSV_CREATED, ERRORS.MUSCLE_TAGS_CSV_FAILED."
    },
    {
      "id": "US-007",
      "title": "Create MuscleTagManagerModal base structure",
      "description": "As a user, I want a modal to view and search my muscle tags.",
      "acceptanceCriteria": [
        "Create `app/features/modals/MuscleTagManagerModal.ts` extending ModalBase",
        "Modal title: 'Manage Muscle Tags'",
        "Display list of all tags from MuscleTagService",
        "Each list item shows: tag name, mapped muscle group",
        "Add SearchBox component to filter tags by name",
        "Style consistent with other plugin modals",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 7,
      "passes": true,
      "notes": "Created MuscleTagManagerModal.ts extending ModalBase. Features: (1) Displays all tags in a sortable table with Tag and Muscle Group columns; (2) SearchBox with real-time filtering by tag or muscle group; (3) Count display showing number of tags/matches; (4) Async tag loading from MuscleTagService with error handling. Added UI constants: MODAL_UI.TITLES.MUSCLE_TAG_MANAGER, MODAL_UI.LABELS.TAG/MUSCLE_GROUP/ACTIONS, MODAL_UI.PLACEHOLDERS.SEARCH_TAGS, MODAL_UI.NOTICES.MUSCLE_TAG_LOADING/COUNT/NO_RESULTS."
    },
    {
      "id": "US-008",
      "title": "Add tag CRUD operations to modal",
      "description": "As a user, I want to add, edit, and delete muscle tags in the modal.",
      "acceptanceCriteria": [
        "Add Tag button opens inline form with: tag input, muscle group dropdown",
        "Muscle group dropdown contains canonical groups: chest, back, shoulders, biceps, triceps, quads, hamstrings, glutes, calves, abs, core, forearms, traps, rear_delts",
        "Click on existing tag opens edit form with current values",
        "Delete button on each tag (with confirmation)",
        "Save updates CSV via MuscleTagService",
        "List refreshes after add/edit/delete",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 8,
      "passes": true,
      "notes": "Implemented full CRUD operations in MuscleTagManagerModal.ts: (1) Add Tag button shows inline form with tag input and muscle group dropdown; (2) CANONICAL_MUSCLE_GROUPS constant added to muscles.constants.ts with all 14 canonical groups; (3) Clicking tag/row opens edit form (tag input disabled since it's the key); (4) Delete button with ConfirmModal confirmation; (5) Save calls MuscleTagService.saveTags() and refreshes list; (6) Added UI constants for new labels, notices, and placeholders. Search is preserved across CRUD operations."
    },
    {
      "id": "US-009",
      "title": "Add fuzzy matching suggestions when adding tags",
      "description": "As a user, I want to see suggestions for similar existing tags when adding a new one.",
      "acceptanceCriteria": [
        "When typing new tag, show similar existing tags (Levenshtein distance <= 2)",
        "Suggestions show: existing tag name + its muscle group",
        "Click suggestion populates form with that tag for editing",
        "Show warning icon if new tag is very similar to existing (possible duplicate)",
        "Suggestions update as user types (debounced)",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 9,
      "passes": true,
      "notes": "Implemented fuzzy matching suggestions in MuscleTagManagerModal.ts: (1) Uses StringUtils.levenshteinDistance() with maxDistance=2 for suggestions; (2) Shows warning icon (⚠️) for very similar tags (distance<=1); (3) Suggestions display tag name + muscle group in a styled list; (4) Click on suggestion calls showEditForm() to edit that tag; (5) 150ms debounce on input for performance; (6) Added UI constants: MUSCLE_TAG_SIMILAR_WARNING, MUSCLE_TAG_SIMILAR_FOUND, SIMILAR_TAGS label; (7) Created _tag-manager.scss with styles for suggestions container and items; (8) Cleanup of debounce timeout in hideForm() and onClose()."
    },
    {
      "id": "US-010",
      "title": "Add export functionality to modal",
      "description": "As a user, I want to export my muscle tags to a CSV file for backup.",
      "acceptanceCriteria": [
        "Add 'Export' button in modal header/footer",
        "Button triggers download of current tags as CSV",
        "CSV format matches the muscle-tags.csv structure",
        "Filename: muscle-tags-export.csv",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 10,
      "passes": true,
      "notes": "Added Export button in modal header section next to Add tag button. Export functionality uses Blob + URL.createObjectURL for browser download. CSV format: tag,muscleGroup with proper escaping for special characters (commas, quotes, newlines). Tags are sorted alphabetically. Added UI constants: EXPORT_TAGS label, MUSCLE_TAG_EXPORTED success notice, MUSCLE_TAG_EXPORT_ERROR error notice. Added escapeCsvValue() helper method for proper CSV escaping."
    },
    {
      "id": "US-011",
      "title": "Add import functionality to modal",
      "description": "As a user, I want to import muscle tags from a CSV file.",
      "acceptanceCriteria": [
        "Add 'Import' button in modal header/footer",
        "Button opens file picker for CSV files",
        "Validate CSV format: must have tag,muscleGroup columns",
        "Validate muscleGroup values are canonical (show error for invalid)",
        "Show preview of tags to import with count",
        "Option buttons: 'Merge' (add new only) or 'Replace' (overwrite all)",
        "Update CSV and refresh list after import",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 11,
      "passes": true,
      "notes": "Implemented import functionality in MuscleTagManagerModal.ts: (1) Added Import button in header section next to Export; (2) Hidden file input with accept='.csv' triggered by button click; (3) CSV parsing with header detection (tag, muscleGroup columns) and quoted value handling; (4) Validation against CANONICAL_MUSCLE_GROUPS with error collection; (5) Import preview showing first 10 tags with error summary; (6) Merge button adds new tags only; Replace button overwrites all; (7) Saves via MuscleTagService.saveTags() and refreshes list. Added UI constants: IMPORT_TAGS, IMPORT_MERGE, IMPORT_REPLACE labels."
    },
    {
      "id": "US-012",
      "title": "Register command to open tag manager modal",
      "description": "As a user, I want to access the tag manager from the command palette.",
      "acceptanceCriteria": [
        "Register command 'Workout: Manage muscle tags' in CommandHandlerService",
        "Command opens MuscleTagManagerModal",
        "Command appears in command palette",
        "Typecheck passes"
      ],
      "priority": 12,
      "passes": true,
      "notes": "Registered 'Workout: Manage muscle tags' command in CommandHandlerService.ts. Added MANAGE_MUSCLE_TAGS constant to COMMANDS_UI in ui.constants.ts. Command opens MuscleTagManagerModal. All tests pass.\n"
    },
    {
      "id": "US-013",
      "title": "Final validation and integration testing",
      "description": "As a developer, I want to verify the complete feature works end-to-end.",
      "acceptanceCriteria": [
        "Adding custom tag in modal makes it available in heatmap filters",
        "Tags persist after Obsidian restart",
        "Default tags work when CSV doesn't exist",
        "Fuzzy matching prevents obvious duplicates",
        "Import/export roundtrip preserves all tags",
        "npm run lint passes",
        "npm test passes",
        "npm run build succeeds",
        "Typecheck passes"
      ],
      "priority": 13,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-014",
      "title": "Add command to generate read-only tag reference note",
      "description": "As a user, I want a command to generate a reference note listing all muscle tags. The note should be considered read-only and fully regenerated by the command to ensure data consistency.",
      "acceptanceCriteria": [
        "Register command 'Workout: Generate tag reference note' in CommandHandlerService",
        "Command fetches all tags from MuscleTagService",
        "Create or Overwrite a file named `Muscle Tags Reference.md` (or configurable name)",
        "Add a clear header warning: '%% ⚠️ DO NOT EDIT MANUALLY. This file is auto-generated by the Workout Plugin. %%'",
        "Format output as a Markdown table with columns: Tag, Muscle Group",
        "Ensure running the command completely replaces file content (discarding any manual user edits)",
        "Show a notification (Notice) upon successful generation",
        "Typecheck passes"
      ],
      "priority": 14,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-015",
      "title": "Remove legacy muscle tag constants",
      "description": "As a developer, I want to remove the deprecated hardcoded muscle tag map to ensure the new Service is the sole source of truth and reduce technical debt.",
      "acceptanceCriteria": [
        "Remove `MUSCLE_TAG_MAP` export from `app/constants/muscles.constants.ts`",
        "Verify no files are importing `MUSCLE_TAG_MAP` directly (grep check)",
        "Remove any temporary legacy bridge code in DataFilter or HeatMap",
        "Ensure default tags are now strictly handled by `MuscleTagService` internals only",
        "Verify that `muscles.constants.ts` only contains the CANONICAL_MUSCLE_GROUPS list (the keys)",
        "Typecheck passes",
        "npm test passes"
      ],
      "priority": 15,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-016",
      "title": "Update README documentation",
      "description": "As a developer, I want to update the README to explain the new custom muscle tag features, commands, and CSV structure.",
      "acceptanceCriteria": [
        "Add 'Custom Muscle Tags' section to README.md",
        "Explain how to open and use the 'Manage Muscle Tags' modal",
        "Document the CSV file location and valid format (`tag,muscleGroup`)",
        "List the canonical muscle groups supported (chest, back, shoulders, etc.) so users know what to map to",
        "Document the new commands: 'Manage muscle tags' and 'Generate tag reference note'",
        "Explain Import/Export features",
        "Mention the 'Create muscle tags CSV' button in settings",
        "Typecheck passes"
      ],
      "priority": 16,
      "passes": false,
      "notes": ""
    }
  ]
}
