{
  "project": "obsidian-workout-plugin",
  "branchName": "ralph/custom-muscle-tag-mapping",
  "description": "Custom Muscle Tag Mapping System - Allow users to create custom muscle tags in any language and map them to canonical muscle groups via CSV file with fuzzy matching suggestions.",
  "userStories": [
    {
      "id": "US-001",
      "title": "Create MuscleTagService with CSV read/write",
      "description": "As a developer, I need a service to read and write the muscle tags CSV file with caching and fallback to defaults.",
      "acceptanceCriteria": [
        "Create `app/services/MuscleTagService.ts` as singleton service",
        "CSV structure: `tag,muscleGroup` (e.g., `petto,chest`)",
        "Implement `loadTags(): Promise<Map<string, string>>` - reads CSV, returns tag->muscleGroup map",
        "Implement `saveTags(tags: Map<string, string>): Promise<void>` - writes CSV",
        "Implement `getTagMap(): Map<string, string>` - returns cached tags or default MUSCLE_TAG_MAP",
        "CSV path: same folder as settings.dataFilePath with filename `muscle-tags.csv`",
        "Cache tags with invalidation when file changes (use vault.on('modify'))",
        "Fallback to MUSCLE_TAG_MAP from muscles.constants.ts if CSV doesn't exist",
        "Handle malformed CSV gracefully (skip invalid rows, log warning)",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Implemented MuscleTagService with all required methods. Uses vault.on('modify') for cache invalidation. Includes helper methods: csvExists(), createDefaultCsv(), getCsvPath(), getTagMapAsObject(). Service needs destroy() call on plugin unload."
    },
    {
      "id": "US-002",
      "title": "Add unit tests for MuscleTagService",
      "description": "As a developer, I want unit tests for MuscleTagService to ensure it works correctly.",
      "acceptanceCriteria": [
        "Create `app/services/__tests__/MuscleTagService.test.ts`",
        "Test loadTags parses valid CSV correctly",
        "Test loadTags returns default tags when CSV doesn't exist",
        "Test loadTags handles malformed CSV rows gracefully",
        "Test saveTags writes correct CSV format",
        "Test getTagMap returns cached data on subsequent calls",
        "Test cache invalidation when file path matches",
        "npm test passes",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Created comprehensive test suite with 35 tests covering: constructor behavior, loadTags (CSV parsing, defaults, malformed rows, quoted values, header handling, concurrent requests), saveTags (format, existing file modification, folder creation, escaping, cache update, error handling), getTagMap (caching, defaults, background loading), getTagMapAsObject, cache invalidation (file modify, different file, manual clear), csvExists, createDefaultCsv, destroy, getCsvPath."
    },
    {
      "id": "US-003",
      "title": "Add Levenshtein distance utility for fuzzy matching",
      "description": "As a developer, I need a Levenshtein distance function for fuzzy tag matching.",
      "acceptanceCriteria": [
        "Add `levenshteinDistance(a: string, b: string): number` to `app/utils/StringUtils.ts`",
        "Function computes edit distance between two strings",
        "Add `findSimilarStrings(needle: string, haystack: string[], maxDistance: number): string[]` helper",
        "Case-insensitive comparison (convert both to lowercase)",
        "Export both functions from StringUtils.ts",
        "Add unit tests in `app/utils/__tests__/StringUtils.test.ts`",
        "Test Levenshtein: 'kitten' vs 'sitting' = 3",
        "Test Levenshtein: 'chest' vs 'chest' = 0",
        "Test findSimilarStrings returns matches within maxDistance",
        "npm test passes",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-004",
      "title": "Integrate MuscleTagService into DataFilter",
      "description": "As a developer, I need DataFilter to use MuscleTagService instead of hardcoded MUSCLE_TAG_MAP.",
      "acceptanceCriteria": [
        "DataFilter constructor accepts MuscleTagService instance",
        "Replace direct MUSCLE_TAG_MAP usage with service.getTagMap()",
        "Update CodeBlockProcessorService to pass service to DataFilter",
        "Existing tests continue to pass (may need mock service)",
        "Typecheck passes",
        "npm test passes"
      ],
      "priority": 4,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-005",
      "title": "Integrate MuscleTagService into MuscleHeatMap",
      "description": "As a developer, I need MuscleHeatMap to use MuscleTagService for muscle group lookups.",
      "acceptanceCriteria": [
        "MuscleHeatMap component accepts MuscleTagService or tag map",
        "Replace direct MUSCLE_TAG_MAP usage with service.getTagMap()",
        "Update EmbeddedDashboardView to pass service to MuscleHeatMap",
        "Heatmap still renders correctly with custom tags",
        "Typecheck passes",
        "npm test passes"
      ],
      "priority": 5,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-006",
      "title": "Add settings button to create default tag CSV",
      "description": "As a user, I want a button in settings to create the muscle tags CSV with default values.",
      "acceptanceCriteria": [
        "Add 'Create muscle tags CSV' button in WorkoutChartsSettingTab",
        "Button calls MuscleTagService to create CSV with all MUSCLE_TAG_MAP defaults",
        "If file exists, show confirmation modal before overwriting",
        "Show success Notice on creation",
        "Show error Notice if creation fails",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 6,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-007",
      "title": "Create MuscleTagManagerModal base structure",
      "description": "As a user, I want a modal to view and search my muscle tags.",
      "acceptanceCriteria": [
        "Create `app/features/modals/MuscleTagManagerModal.ts` extending ModalBase",
        "Modal title: 'Manage Muscle Tags'",
        "Display list of all tags from MuscleTagService",
        "Each list item shows: tag name, mapped muscle group",
        "Add SearchBox component to filter tags by name",
        "Style consistent with other plugin modals",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 7,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-008",
      "title": "Add tag CRUD operations to modal",
      "description": "As a user, I want to add, edit, and delete muscle tags in the modal.",
      "acceptanceCriteria": [
        "Add Tag button opens inline form with: tag input, muscle group dropdown",
        "Muscle group dropdown contains canonical groups: chest, back, shoulders, biceps, triceps, quads, hamstrings, glutes, calves, abs, core, forearms, traps, rear_delts",
        "Click on existing tag opens edit form with current values",
        "Delete button on each tag (with confirmation)",
        "Save updates CSV via MuscleTagService",
        "List refreshes after add/edit/delete",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 8,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-009",
      "title": "Add fuzzy matching suggestions when adding tags",
      "description": "As a user, I want to see suggestions for similar existing tags when adding a new one.",
      "acceptanceCriteria": [
        "When typing new tag, show similar existing tags (Levenshtein distance <= 2)",
        "Suggestions show: existing tag name + its muscle group",
        "Click suggestion populates form with that tag for editing",
        "Show warning icon if new tag is very similar to existing (possible duplicate)",
        "Suggestions update as user types (debounced)",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 9,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-010",
      "title": "Add export functionality to modal",
      "description": "As a user, I want to export my muscle tags to a CSV file for backup.",
      "acceptanceCriteria": [
        "Add 'Export' button in modal header/footer",
        "Button triggers download of current tags as CSV",
        "CSV format matches the muscle-tags.csv structure",
        "Filename: muscle-tags-export.csv",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 10,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-011",
      "title": "Add import functionality to modal",
      "description": "As a user, I want to import muscle tags from a CSV file.",
      "acceptanceCriteria": [
        "Add 'Import' button in modal header/footer",
        "Button opens file picker for CSV files",
        "Validate CSV format: must have tag,muscleGroup columns",
        "Validate muscleGroup values are canonical (show error for invalid)",
        "Show preview of tags to import with count",
        "Option buttons: 'Merge' (add new only) or 'Replace' (overwrite all)",
        "Update CSV and refresh list after import",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 11,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-012",
      "title": "Register command to open tag manager modal",
      "description": "As a user, I want to access the tag manager from the command palette.",
      "acceptanceCriteria": [
        "Register command 'Workout: Manage muscle tags' in CommandHandlerService",
        "Command opens MuscleTagManagerModal",
        "Command appears in command palette",
        "Typecheck passes"
      ],
      "priority": 12,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-013",
      "title": "Final validation and integration testing",
      "description": "As a developer, I want to verify the complete feature works end-to-end.",
      "acceptanceCriteria": [
        "Adding custom tag in modal makes it available in heatmap filters",
        "Tags persist after Obsidian restart",
        "Default tags work when CSV doesn't exist",
        "Fuzzy matching prevents obvious duplicates",
        "Import/export roundtrip preserves all tags",
        "npm run lint passes",
        "npm test passes",
        "npm run build succeeds",
        "Typecheck passes"
      ],
      "priority": 13,
      "passes": false,
      "notes": ""
    }
  ]
}
