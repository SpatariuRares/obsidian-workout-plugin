{
  "project": "obsidian-workout-plugin",
  "branchName": "ralph/duplicate-logic-refactor",
  "description": "Eliminate duplicate code patterns to improve maintainability: consolidate formatDate, extract custom fields utility, refactor modal opening patterns, and standardize workout toggle handlers.",
  "userStories": [
    {
      "id": "US-001",
      "title": "Consolidate formatDate into DateUtils",
      "description": "As a developer, I want a single date formatting function so that date logic is consistent and bug fixes apply everywhere.",
      "acceptanceCriteria": [
        "Delete the `formatDate()` method from `app/utils/ChartDataUtils.ts` (lines 17-34)",
        "Replace all internal usages of `this.formatDate()` in ChartDataUtils with `DateUtils.formatDateWithFormat()`",
        "Add import for DateUtils at top of ChartDataUtils.ts",
        "Chart labels still display dates correctly in formats: DD/MM/YYYY, YYYY-MM-DD, MM/DD/YYYY",
        "npm run lint passes",
        "npm test passes",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Completed 2026-02-01. Removed duplicate formatDate from ChartDataUtils, now uses DateUtils.formatDateWithFormat. Updated tests in utils.test.ts to test DateUtils.formatDateWithFormat instead."
    },
    {
      "id": "US-002",
      "title": "Create FormUtils with setupWorkoutToggle",
      "description": "As a developer, I want a reusable workout toggle handler so the enable/disable logic is consistent across all modals.",
      "acceptanceCriteria": [
        "Create new file `app/utils/FormUtils.ts`",
        "Add function `setupWorkoutToggle(toggle: HTMLInputElement, workoutInput: HTMLInputElement, getFileName: () => string): void`",
        "Function adds change event listener that: when checked, disables input, sets value to getFileName(), adds 'workout-opacity-50' class, removes 'workout-opacity-100' class; when unchecked, enables input, clears value, adds 'workout-opacity-100' class, removes 'workout-opacity-50' class",
        "Function also sets initial state based on toggle.checked",
        "Export function from FormUtils.ts",
        "npm run lint passes",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-003",
      "title": "Add fillDynamicInputsFromCustomFields to FormUtils",
      "description": "As a developer, I want a shared utility for filling form inputs from custom fields so that the logic is consistent and null-handling is uniform.",
      "acceptanceCriteria": [
        "Add function `fillDynamicInputsFromCustomFields(customFields: Record<string, string | number | boolean> | undefined, inputMap: Map<string, HTMLInputElement>): void` to FormUtils.ts",
        "Function iterates Object.entries(customFields) when defined",
        "For each [key, value]: skip if value is null or undefined, get input from inputMap.get(key)",
        "If input exists and input.type === 'checkbox', set input.checked = Boolean(value)",
        "Otherwise set input.value = String(value)",
        "Export function from FormUtils.ts",
        "npm run lint passes",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-004",
      "title": "Add unit tests for FormUtils",
      "description": "As a developer, I want unit tests for the new FormUtils functions to ensure they work correctly.",
      "acceptanceCriteria": [
        "Create `app/utils/__tests__/FormUtils.test.ts`",
        "Test setupWorkoutToggle: toggle checked state disables input and sets value",
        "Test setupWorkoutToggle: toggle unchecked state enables input and clears value",
        "Test setupWorkoutToggle: correct CSS classes applied (workout-opacity-50, workout-opacity-100)",
        "Test fillDynamicInputsFromCustomFields: text input filling works",
        "Test fillDynamicInputsFromCustomFields: checkbox input filling works (Boolean conversion)",
        "Test fillDynamicInputsFromCustomFields: null/undefined values are skipped",
        "Test fillDynamicInputsFromCustomFields: missing input keys are handled gracefully",
        "npm test passes",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-005",
      "title": "Refactor CreateExerciseSectionModal to use FormUtils",
      "description": "As a developer, I want CreateExerciseSectionModal to use the shared toggle utility.",
      "acceptanceCriteria": [
        "Import setupWorkoutToggle from '@app/utils/FormUtils'",
        "Replace inline currentWorkoutToggle.addEventListener('change', ...) at lines 150-162 with call to setupWorkoutToggle(currentWorkoutToggle, workoutInput, () => this.getCurrentFileName())",
        "Remove the inline toggle handler code",
        "Behavior remains identical: toggling enables/disables workout input",
        "npm run lint passes",
        "npm test passes",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-006",
      "title": "Refactor TargetSectionWithAutocomplete to use FormUtils",
      "description": "As a developer, I want TargetSectionWithAutocomplete to use the shared toggle utility.",
      "acceptanceCriteria": [
        "Import setupWorkoutToggle from '@app/utils/FormUtils'",
        "Replace handleCurrentWorkoutToggle function at lines 126-138 with call to setupWorkoutToggle(currentWorkoutToggle, workoutInput, () => currentFileName)",
        "Remove the handleCurrentWorkoutToggle function definition",
        "Update handlers object to not include handleCurrentWorkoutToggle (or remove if unused)",
        "Remove the currentWorkoutToggle.addEventListener('change', handleCurrentWorkoutToggle) at line 146",
        "Behavior remains identical",
        "npm run lint passes",
        "npm test passes",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-007",
      "title": "Refactor LogFormRenderer to use FormUtils",
      "description": "As a developer, I want LogFormRenderer to use the shared toggle utility and standardized CSS classes.",
      "acceptanceCriteria": [
        "Import setupWorkoutToggle from '@app/utils/FormUtils'",
        "Replace setupCurrentWorkoutToggle method (lines 153-179) with call to setupWorkoutToggle",
        "Note: CSS classes change from 'opacity-50'/'opacity-100' to 'workout-opacity-50'/'workout-opacity-100' (standardization)",
        "Remove the old setupCurrentWorkoutToggle method",
        "Behavior remains identical",
        "npm run lint passes",
        "npm test passes",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-008",
      "title": "Refactor BaseLogModal to use fillDynamicInputsFromCustomFields",
      "description": "As a developer, I want BaseLogModal.preFillForm to use the shared custom fields utility.",
      "acceptanceCriteria": [
        "Import fillDynamicInputsFromCustomFields from '@app/utils/FormUtils'",
        "In preFillForm method, replace lines 189-201 (the for loop for customFields) with: fillDynamicInputsFromCustomFields(data.customFields, formElements.dynamicFieldInputs)",
        "Remove the inline for loop",
        "Behavior remains identical: form pre-fills with custom field values",
        "npm run lint passes",
        "npm test passes",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-009",
      "title": "Refactor LogFormRenderer to use fillDynamicInputsFromCustomFields",
      "description": "As a developer, I want LogFormRenderer.autoFillFromLastEntry to use the shared custom fields utility.",
      "acceptanceCriteria": [
        "Import fillDynamicInputsFromCustomFields from '@app/utils/FormUtils' (may already be imported from US-007)",
        "In autoFillFromLastEntry method, replace lines 281-293 (the for loop for customFields) with: fillDynamicInputsFromCustomFields(lastEntry.customFields, formElements.dynamicFieldInputs)",
        "Remove the inline for loop",
        "Behavior remains identical: form auto-fills with last entry's custom field values",
        "npm run lint passes",
        "npm test passes",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-010",
      "title": "Extract openCreateLogModal helper in LogCallouts",
      "description": "As a developer, I want the modal opening logic in one place so changes to modal instantiation only need one update.",
      "acceptanceCriteria": [
        "Add private static method `openCreateLogModal(plugin: WorkoutChartsPlugin, exerciseName?: string, onComplete?: () => void): void` to LogCallouts class",
        "Method gets activeView from plugin.app.workspace.getActiveViewOfType(MarkdownView)",
        "Method computes currentPageLink as activeView?.file ? `[[${activeView.file.basename}]]` : ''",
        "Method opens new CreateLogModal(plugin.app, plugin, exerciseName, currentPageLink, onComplete || (() => plugin.triggerWorkoutLogRefresh()))",
        "Update renderCsvNoDataMessage (lines 42-57) to use: this.openCreateLogModal(plugin, exerciseName)",
        "Update renderCreateLogButtonForExercise (lines 121-136) to use: this.openCreateLogModal(plugin, exerciseName)",
        "Both buttons still open the modal correctly",
        "Refresh still triggers after modal close",
        "npm run lint passes",
        "npm test passes",
        "Typecheck passes"
      ],
      "priority": 10,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-011",
      "title": "Final validation and cleanup",
      "description": "As a developer, I want to verify no dead code remains and all tests pass.",
      "acceptanceCriteria": [
        "No unused imports in any modified files",
        "ChartDataUtils.ts no longer contains formatDate method",
        "LogFormRenderer.ts no longer contains setupCurrentWorkoutToggle method",
        "CreateExerciseSectionModal.ts no longer contains inline toggle handler",
        "TargetSectionWithAutocomplete.ts no longer contains handleCurrentWorkoutToggle function",
        "BaseLogModal.ts no longer contains inline customFields for loop",
        "LogCallouts.ts no longer contains duplicate modal opening code",
        "npm run lint passes with no warnings",
        "npm test passes with no failures",
        "npm run build succeeds",
        "Typecheck passes"
      ],
      "priority": 11,
      "passes": false,
      "notes": ""
    }
  ]
}
