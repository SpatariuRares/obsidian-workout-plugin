{
  "project": "obsidian-workout-plugin",
  "branchName": "ralph/memory-leak-fixes-and-performance",
  "description": "Memory Leak Fixes and Performance Improvements - Critical stability fixes for production use",
  "userStories": [
    {
      "id": "US-001",
      "title": "Track and destroy Chart.js instances",
      "description": "As a user with multiple workout charts open, I want the plugin to properly clean up chart instances so my browser doesn't run out of memory.",
      "acceptanceCriteria": [
        "Add chartInstances: Map<string, Chart> to ChartRenderer class in app/features/charts/components/ChartRenderer.ts",
        "Before creating new chart, destroy existing chart if present using chart.destroy()",
        "Generate unique chart IDs based on container element ID or hash of chart parameters",
        "Implement destroyAllCharts() method that iterates Map and calls destroy() on each chart",
        "Export destroyAllCharts() for use in plugin lifecycle cleanup",
        "Typecheck passes",
        "Write unit test mocking Chart.js to verify destroy() is called"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Completed 2026-01-24 - Added Map-based chart tracking, generateChartId method, destroy logic in renderChart, and destroyAllCharts method. Unit tests created and passing."
    },
    {
      "id": "US-002",
      "title": "Add cleanup method to EmbeddedChartView",
      "description": "As a developer, I need EmbeddedChartView to expose a cleanup method so it can be called during plugin unload.",
      "acceptanceCriteria": [
        "Add cleanup() method to EmbeddedChartView in app/views/EmbeddedChartView.ts",
        "cleanup() calls ChartRenderer.destroyAllCharts()",
        "cleanup() clears any internal state or references",
        "Document cleanup() method with JSDoc comment",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Completed 2026-01-24 - Added public cleanup() method with JSDoc documentation. Method calls ChartRenderer.destroyAllCharts() and includes error handling. TypeScript compilation passes."
    },
    {
      "id": "US-003",
      "title": "Refactor EmbeddedTableView with MarkdownRenderChild",
      "description": "As a user with multiple workout log tables, I want event listeners to be properly cleaned up so memory doesn't leak when tables are refreshed.",
      "acceptanceCriteria": [
        "Create TableRenderChild class extending MarkdownRenderChild in app/views/EmbeddedTableView.ts",
        "Add abortController: AbortController property to TableRenderChild",
        "Move event listener registration from direct addEventListener to onload() method",
        "Use { signal: this.abortController.signal } option for all event listeners",
        "Implement onunload() method that calls this.abortController.abort()",
        "Replace direct addEventListener calls with TableRenderChild instances",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Completed 2026-01-24 - Created TableRenderChild class with AbortController. Refactored all event listeners in EmbeddedTableView, TableActions, LogCallouts, and Button component to use AbortSignal for cleanup. Event listeners are now properly cleaned up when tables are refreshed or removed."
    },
    {
      "id": "US-004",
      "title": "Add cleanup method to EmbeddedTableView",
      "description": "As a developer, I need EmbeddedTableView to expose a cleanup method so it can be called during plugin unload.",
      "acceptanceCriteria": [
        "Add cleanup() method to EmbeddedTableView in app/views/EmbeddedTableView.ts",
        "cleanup() aborts all AbortControllers from TableRenderChild instances",
        "cleanup() clears any internal state or references",
        "Document cleanup() method with JSDoc comment",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Completed 2026-01-24 - Added public cleanup() method with JSDoc documentation. Method iterates through renderChildren array, unloads each TableRenderChild (which aborts their AbortControllers), and clears the array to release references. TypeScript compilation passes."
    },
    {
      "id": "US-005",
      "title": "Add cleanup method to EmbeddedDashboardView",
      "description": "As a developer, I need EmbeddedDashboardView to expose a cleanup method so it can be called during plugin unload.",
      "acceptanceCriteria": [
        "Add cleanup() method to EmbeddedDashboardView in app/views/EmbeddedDashboardView.ts",
        "cleanup() clears any event listeners or timers",
        "cleanup() clears any internal state or references",
        "Document cleanup() method with JSDoc comment",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-006",
      "title": "Complete plugin lifecycle cleanup in main.ts",
      "description": "As a user who enables/disables the plugin, I want all resources to be properly cleaned up to prevent memory leaks and zombie event listeners.",
      "acceptanceCriteria": [
        "Call embeddedChartView?.cleanup() in main.ts onunload() method",
        "Call embeddedTableView?.cleanup() in main.ts onunload() method",
        "Call embeddedDashboardView?.cleanup() in main.ts onunload() method",
        "Call dataService.clearLogDataCache() in onunload() method",
        "Call ChartRenderer.destroyAllCharts() in onunload() method",
        "Nullify service references: codeBlockProcessorService = null!, commandHandlerService = null!",
        "Add code comments documenting cleanup order and rationale",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-007",
      "title": "Add recursion protection to addWorkoutLogEntry",
      "description": "As a user trying to log workouts with an invalid CSV path, I want to receive a clear error message instead of a stack overflow crash.",
      "acceptanceCriteria": [
        "Add retryCount parameter with default value 0 to addWorkoutLogEntry() in app/services/DataService.ts",
        "Define MAX_RETRIES = 1 constant at top of DataService class",
        "Check if retryCount >= MAX_RETRIES before recursive call",
        "Throw descriptive Error with CSV path if MAX_RETRIES exceeded",
        "Display user-friendly Notice when CSV creation fails",
        "Increment retryCount on recursive call: addWorkoutLogEntry(entry, retryCount + 1)",
        "Typecheck passes",
        "Write unit test for recursion protection scenario"
      ],
      "priority": 7,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-008",
      "title": "Strengthen CSV parsing validation",
      "description": "As a user, I want malformed CSV entries to be rejected with clear warnings so I can identify and fix data quality issues.",
      "acceptanceCriteria": [
        "Add isNaN() validation checks for reps, weight, volume in parseWorkoutLogCSV() in app/types/WorkoutLogData.ts",
        "Reject entries where reps <= 0 using continue statement",
        "Reject entries where weight < 0 using continue statement",
        "Log console.warn() with line number and raw line content for each skipped entry",
        "Add JSDoc comment documenting expected CSV format",
        "Continue parsing remaining entries after encountering invalid entry",
        "Typecheck passes",
        "Write unit tests for malformed CSV input scenarios (NaN, negative values, empty fields)"
      ],
      "priority": 8,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-009",
      "title": "Fix weak parameter parsing",
      "description": "As a developer debugging code block parameters, I want proper validation so empty strings aren't silently converted to 0.",
      "acceptanceCriteria": [
        "Add value && check before !isNaN(Number(value)) in parseCodeBlockParams() in app/services/CodeBlockProcessorService.ts",
        "Change condition to: } else if (value && !isNaN(Number(value))) {",
        "Add code comment explaining why empty string check is needed",
        "Typecheck passes",
        "Write unit tests for parameter parsing edge cases (empty string, whitespace, '0', valid numbers)"
      ],
      "priority": 9,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-010",
      "title": "Implement cache size limits",
      "description": "As a user with a large workout history (10,000+ entries), I want the plugin cache to have size limits so it doesn't consume excessive memory.",
      "acceptanceCriteria": [
        "Define MAX_CACHE_SIZE = 5000 constant in DataService in app/services/DataService.ts",
        "Add cache size check in getWorkoutLogData() before using cached data",
        "Clear cache if logDataCache.length > MAX_CACHE_SIZE before repopulating",
        "Add debug mode logging for cache statistics (size, hit/miss)",
        "Add JSDoc comment documenting cache strategy and size limit rationale",
        "Typecheck passes",
        "Write unit test for cache eviction when size exceeds limit"
      ],
      "priority": 10,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-011",
      "title": "Optimize filtering string operations",
      "description": "As a user filtering workout logs, I want fast filtering performance even with thousands of entries.",
      "acceptanceCriteria": [
        "Pre-compute normalized exercise filter before loop in applyEarlyFiltering() in app/services/DataService.ts",
        "Pre-compute normalized workout filter before loop in applyEarlyFiltering()",
        "Store normalized filters in const variables outside filter loop",
        "Remove redundant toLowerCase().replace().trim() calls from inside filter loop",
        "Add code comment documenting optimization rationale",
        "Typecheck passes",
        "Write unit tests verifying filter correctness is preserved after optimization"
      ],
      "priority": 11,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-012",
      "title": "Replace custom trigger logic with Obsidian APIs",
      "description": "As a plugin user, I want workout log refreshes to use proper Obsidian APIs so the plugin doesn't depend on external plugins or use undocumented APIs.",
      "acceptanceCriteria": [
        "Replace app.workspace.trigger('dataview:refresh-views') with workspace.iterateRootLeaves() in main.ts",
        "Use app.metadataCache.trigger('changed', file) for metadata updates instead of vault.trigger('raw')",
        "Remove Dataview plugin dependency from refresh logic",
        "Test refresh behavior works correctly without Dataview installed",
        "Add code comments documenting proper Obsidian API usage",
        "Typecheck passes"
      ],
      "priority": 12,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-013",
      "title": "Add DataService unit tests",
      "description": "As a developer, I want unit tests for DataService to prevent regressions in CSV parsing and caching.",
      "acceptanceCriteria": [
        "Create __tests__/DataService.test.ts file",
        "Write test for CSV parsing with malformed input (invalid numbers, missing fields)",
        "Write test for recursion protection in addWorkoutLogEntry",
        "Write test for cache eviction when size exceeds MAX_CACHE_SIZE",
        "Write test for filtering optimization correctness",
        "Mock TFile and Vault APIs using Jest mocks",
        "All tests pass with npm test",
        "Typecheck passes"
      ],
      "priority": 13,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-014",
      "title": "Add ChartRenderer unit tests",
      "description": "As a developer, I want unit tests for ChartRenderer to verify Chart.js instances are properly destroyed.",
      "acceptanceCriteria": [
        "Create __tests__/ChartRenderer.test.ts file",
        "Mock Chart.js constructor and destroy() method using Jest",
        "Write test verifying destroy() is called on existing chart before creating new one",
        "Write test verifying destroyAllCharts() calls destroy() on all tracked instances",
        "Write test verifying chartInstances Map is cleared after destroyAllCharts()",
        "All tests pass with npm test",
        "Typecheck passes"
      ],
      "priority": 14,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-015",
      "title": "Configure Jest coverage thresholds",
      "description": "As a developer, I want enforced test coverage thresholds to maintain code quality.",
      "acceptanceCriteria": [
        "Update jest.config.js to set coverage thresholds: statements: 70, branches: 70, functions: 70, lines: 70",
        "Add collectCoverageFrom patterns for app/services/DataService.ts, app/features/charts/components/ChartRenderer.ts",
        "Run npm run test:coverage and verify it passes",
        "Add coverage report to .gitignore if not already present",
        "Typecheck passes",
        "All tests pass with npm test"
      ],
      "priority": 15,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-016",
      "title": "Enable TypeScript strict mode",
      "description": "As a developer, I want strict null checks enabled to catch potential null/undefined errors at compile time.",
      "acceptanceCriteria": [
        "Add \"strict\": true to tsconfig.json compilerOptions",
        "Add \"strictNullChecks\": true to tsconfig.json compilerOptions",
        "Add \"noImplicitAny\": true to tsconfig.json compilerOptions",
        "Fix all TypeScript errors revealed by strict mode (null checks, implicit any, etc.)",
        "Run npm run build and verify TypeScript compilation passes",
        "Update CLAUDE.md documenting strict mode is now enabled",
        "Typecheck passes"
      ],
      "priority": 16,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-017",
      "title": "Add CSV injection protection",
      "description": "As a user exporting workout data to external spreadsheets, I want protection against CSV formula injection.",
      "acceptanceCriteria": [
        "Add formula injection detection regex /^[=+\\-@]/ to entryToCSVLine() in app/types/WorkoutLogData.ts",
        "Prefix detected formulas with single quote character before escaping",
        "Add code comment documenting CSV injection protection rationale",
        "Typecheck passes",
        "Write unit tests for formula injection scenarios (=1+1, +1, -1, @SUM)"
      ],
      "priority": 17,
      "passes": false,
      "notes": ""
    }
  ]
}
