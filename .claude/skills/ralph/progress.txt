# Ralph Progress Log - Custom Muscle Tag Mapping

Branch: ralph/custom-muscle-tag-mapping
Started: 2026-02-01

---

## 2026-02-01 - US-001: Create MuscleTagService with CSV read/write

**Status:** COMPLETE

**What was done:**
- Created `app/services/MuscleTagService.ts` with all required functionality
- Implemented `loadTags(): Promise<Map<string, string>>` - reads CSV, returns tag->muscleGroup map
- Implemented `saveTags(tags: Map<string, string>): Promise<void>` - writes CSV with proper escaping
- Implemented `getTagMap(): Map<string, string>` - returns cached tags or defaults (sync with background refresh)
- CSV path computed from `settings.csvLogFilePath` folder + `muscle-tags.csv`
- Cache invalidation via `vault.on('modify')` file watcher
- Fallback to `MUSCLE_TAG_MAP` from `muscles.constants.ts` when CSV doesn't exist
- Graceful handling of malformed CSV rows (skip with warning)
- Added helper methods: `csvExists()`, `createDefaultCsv()`, `getCsvPath()`, `getTagMapAsObject()`
- Added `destroy()` method for cleanup on plugin unload

**Exported from:** `@app/services/index.ts`

**Typecheck:** PASS
**Tests:** PASS (490 tests)

**Notes for next developer:**
- Service is NOT yet integrated into the plugin (main.ts). This will be needed when integrating with DataFilter (US-004) and MuscleHeatMap (US-005).
- The `destroy()` method should be called in `onunload()` of main.ts when the service is added there.
- Next priority: US-002 (Add unit tests for MuscleTagService)

---

## 2026-02-01 - US-002: Add unit tests for MuscleTagService

**Status:** COMPLETE

**What was done:**
- Created `app/services/__tests__/MuscleTagService.test.ts` with 35 comprehensive unit tests
- Tests cover all acceptance criteria and additional edge cases:
  - **Constructor tests:** file watcher registration, CSV path computation (including root-level paths)
  - **loadTags tests:** valid CSV parsing, default fallback when CSV doesn't exist, empty CSV handling, malformed row handling (skip invalid, accept extra columns), header line detection, case normalization, quoted value parsing, read error handling, concurrent request deduplication
  - **saveTags tests:** correct CSV format, existing file modification, parent folder creation, special character escaping, cache update, error propagation
  - **getTagMap tests:** cache usage on subsequent calls, synchronous default return, background loading
  - **getTagMapAsObject tests:** correct object conversion
  - **Cache invalidation tests:** clearing on file modify event, ignoring unrelated files, manual cache clearing
  - **csvExists tests:** file exists, doesn't exist, folder vs file
  - **createDefaultCsv tests:** creation when missing, no-op when exists
  - **destroy tests:** file watcher unregistration, cache clearing
  - **getCsvPath tests:** path return

**Test patterns used:**
- Mocked Obsidian module (TFile, TAbstractFile, normalizePath, EventRef)
- Mock vault interface with jest.fn() for all vault methods
- File modify callback capture for testing cache invalidation
- Console.warn spy for validating warning logs

**Exported from:** Test file only

**Typecheck:** PASS
**Tests:** PASS (525 tests total, 35 new)

**Notes for next developer:**
- Test patterns follow the existing DataService.test.ts structure
- Mock interface types defined inline (MockVault, MockApp, MockEventCallback)
- Next priority: US-003 (Add Levenshtein distance utility for fuzzy matching)

---

## 2026-02-01 - US-003: Add Levenshtein distance utility for fuzzy matching

**Status:** COMPLETE

**What was done:**
- Created `app/utils/StringUtils.ts` as a static utility class
- Implemented `levenshteinDistance(a: string, b: string): number`:
  - Standard dynamic programming algorithm using a 2D matrix
  - Case-insensitive comparison (both strings lowercased)
  - Returns number of single-character edits (insertions, deletions, substitutions)
- Implemented `findSimilarStrings(needle: string, haystack: string[], maxDistance: number): string[]`:
  - Returns all strings from haystack within maxDistance of needle
  - Results sorted by distance (closest first), then alphabetically for ties
  - Case-insensitive matching
- Exported from `@app/utils/index.ts`
- Created comprehensive test suite with 24 tests in `app/utils/__tests__/StringUtils.test.ts`

**Test coverage includes:**
- **levenshteinDistance tests (11):** identical strings, case insensitivity, classic 'kitten/sitting' = 3, empty strings, single-char edits, longer strings ('flaw/lawn'), muscle tag examples, unicode, completely different strings
- **findSimilarStrings tests (13):** exact matches, case insensitivity, empty results, distance filtering, sorting by distance, alphabetical tie-breaking, empty needle/haystack, multiple matches, practical typo detection, duplicate detection for muscle tags

**Exported from:** `@app/utils` (via barrel export)

**Typecheck:** PASS
**Tests:** PASS (549 tests total, 24 new)

**Notes for next developer:**
- StringUtils follows the same static class pattern as DateUtils
- The levenshtein algorithm is O(m*n) where m and n are string lengths - efficient for typical tag names
- These utilities will be used in US-009 for fuzzy matching suggestions when adding new muscle tags
- Next priority: US-004 (Integrate MuscleTagService into DataFilter)

---

## 2026-02-01 - Refactor: Consolidate string matching utilities

**Status:** COMPLETE

**What was done:**
- Moved `getMatchScore()` from `ExerciseMatchUtils` to `StringUtils` as the canonical location
- `ExerciseMatchUtils.getMatchScore()` now delegates to `StringUtils.getMatchScore()` for backward compatibility
- Added 9 new tests for `StringUtils.getMatchScore()` (existing tests in utils.test.ts still pass via delegation)
- StringUtils now contains both matching approaches:
  - `getMatchScore()` - Semantic/heuristic matching (100=exact, 90=starts-with, 80=ends-with, 70=all-words, 60=partial-words, 50=substring, 0=none)
  - `levenshteinDistance()` - Edit distance for typo detection
  - `findSimilarStrings()` - Fuzzy search helper using Levenshtein

**Why two approaches:**
| Use Case | getMatchScore | levenshtein |
|----------|--------------|-------------|
| "Bench Press" vs "Incline Bench" | 70 (words) | 7 (many edits) |
| "peto" vs "petto" (typo) | 0 (no match) | 1 (caught!) |
| "chest" vs "chests" | 50 (substring) | 1 (caught!) |

**Typecheck:** PASS
**Tests:** PASS (558 tests total, 33 in StringUtils)

**Notes for next developer:**
- All exercise matching still works via delegation - no breaking changes
- Use `StringUtils.getMatchScore()` for semantic similarity (exercise matching)
- Use `StringUtils.levenshteinDistance()` or `findSimilarStrings()` for typo detection (tag deduplication)
- Next priority: US-004 (Integrate MuscleTagService into DataFilter)
