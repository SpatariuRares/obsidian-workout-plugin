# Progress Log - Obsidian Workout Plugin

## 2026-02-02 - US-004: Integrate MuscleTagService into DataFilter

**Status:** COMPLETE

**Summary:**
Integrated MuscleTagService into the plugin's service layer. The service is now initialized in main.ts and accessible via DataFilter's static methods.

**Key changes:**
1. `main.ts` - Added MuscleTagService initialization and lifecycle management
2. `app/services/CodeBlockProcessorService.ts` - Accepts and sets MuscleTagService on DataFilter
3. `app/services/data/DataFilter.ts` - Added static service accessor methods (setMuscleTagService, getMuscleTagService, getTagMap, clearMuscleTagService)
4. Tests updated to mock the new MuscleTagService parameter

**Access patterns:**
- Via plugin: `plugin.getMuscleTagService()`
- Via DataFilter: `DataFilter.getMuscleTagService()` or `DataFilter.getTagMap()`

**Next priority:** US-005 (Integrate MuscleTagService into MuscleHeatMap)

**Note for next developer:**
For US-005, the key change is updating `MuscleTagMapper.ts` to use `DataFilter.getTagMap()` instead of `CONSTANTS.WORKOUT.MUSCLES.TAG_MAP`. The service is now available through the DataFilter static accessor.

## 2026-02-02 - US-005: Integrate MuscleTagService into MuscleHeatMap

**Status:** COMPLETE

**Summary:**
Integrated MuscleTagService into MuscleHeatMap by updating MuscleTagMapper to use custom muscle tags from the service.

**Key changes:**
1. `app/features/dashboard/business/muscleHeatMap/MuscleTagMapper.ts`:
   - Added import for `DataFilter`
   - Added private `getTagMap()` helper method that:
     - Returns custom tags from `DataFilter.getTagMap()` if available
     - Falls back to `CONSTANTS.WORKOUT.MUSCLES.TAG_MAP` otherwise
   - Updated `findMuscleGroupsFromTags()` to use the new `getTagMap()` helper
   - Changed from object bracket notation to `Map.get()` for tag lookups
   - Changed from `Object.entries().forEach()` to `Map.forEach()` for iteration

**Design decision:**
No changes to EmbeddedDashboardView were needed since MuscleTagMapper accesses the service via DataFilter's static methods (established in US-004). This keeps the component interface simple while still supporting custom tags.

**Next priority:** US-006 (Add settings button to create default tag CSV)

**Note for next developer:**
For US-006, you need to add a button in `WorkoutChartsSettingTab` that calls `MuscleTagService.createDefaultCsv()`. The service is accessible via `plugin.getMuscleTagService()` or `DataFilter.getMuscleTagService()`. Remember to handle the confirmation modal for overwriting existing files.

## 2026-02-02 - US-006: Add settings button to create default tag CSV

**Status:** COMPLETE

**Summary:**
Added a "Create muscle tags" button in the settings under the CSV Management section. The button creates a muscle-tags.csv file with all default MUSCLE_TAG_MAP values.

**Key changes:**
1. `app/constants/ui.constants.ts` - Added UI constants:
   - `SETTINGS_UI.LABELS.CREATE_MUSCLE_TAGS_CSV` - label for the setting
   - `SETTINGS_UI.DESCRIPTIONS.CREATE_MUSCLE_TAGS_CSV` - description explaining the feature
   - `SETTINGS_UI.DESCRIPTIONS.CONFIRM_OVERWRITE_MUSCLE_TAGS` - confirmation message for overwriting
   - `SETTINGS_UI.BUTTONS.CREATE_MUSCLE_TAGS` - button text
   - `MESSAGES_UI.SUCCESS.MUSCLE_TAGS_CSV_CREATED` - success notice
   - `MESSAGES_UI.ERRORS.MUSCLE_TAGS_CSV_FAILED` - error notice (function)

2. `app/features/settings/components/GeneralSettings.ts`:
   - Added import for `ConfirmModal`
   - Added new Setting with button under CSV Management section
   - Added `handleCreateMuscleTagsCsv()` method - checks if file exists, shows confirmation modal if yes
   - Added `createMuscleTagsCsvWithDefaults()` method - creates/overwrites file with default tags

**Behavior:**
- If CSV doesn't exist: Creates file immediately, shows success notice
- If CSV exists: Shows ConfirmModal warning user custom tags will be lost, then overwrites on confirm
- On error: Shows error notice with error message

**Next priority:** US-007 (Create MuscleTagManagerModal base structure)

**Note for next developer:**
For US-007, create `app/features/modals/MuscleTagManagerModal.ts` extending ModalBase. The modal should display all tags from MuscleTagService with search functionality. Reference existing modals like `AuditExerciseNamesModal.ts` for patterns. Use SearchBox from molecules for filtering.

## 2026-02-02 - US-007: Create MuscleTagManagerModal base structure

**Status:** COMPLETE

**Summary:**
Created the MuscleTagManagerModal for viewing and searching muscle tags. The modal displays all tags from MuscleTagService in a sortable table with real-time search filtering.

**Key changes:**
1. `app/features/modals/MuscleTagManagerModal.ts` - New modal extending ModalBase:
   - Displays tags in a table with "Tag" and "Muscle Group" columns
   - SearchBox component for filtering by tag or muscle group (real-time input filtering)
   - Count display showing total/filtered tag count
   - Async tag loading from MuscleTagService with error handling
   - Tags sorted alphabetically for easy browsing

2. `app/constants/ui.constants.ts` - Added UI constants:
   - `MODAL_UI.TITLES.MUSCLE_TAG_MANAGER` - "Manage muscle tags"
   - `MODAL_UI.LABELS.TAG`, `MUSCLE_GROUP`, `ACTIONS` - table column headers
   - `MODAL_UI.PLACEHOLDERS.SEARCH_TAGS` - search box placeholder
   - `MODAL_UI.NOTICES.MUSCLE_TAG_LOADING`, `MUSCLE_TAG_COUNT`, `MUSCLE_TAG_NO_RESULTS` - status messages

**Implementation details:**
- Uses `plugin.getMuscleTagService().loadTags()` to fetch tags asynchronously
- Real-time filtering via `input` event listener (not `change`)
- Filter matches on both tag name and muscle group
- Empty state handled when no tags match search

**Next priority:** US-008 (Add tag CRUD operations to modal)

**Note for next developer:**
For US-008, you need to add CRUD operations to MuscleTagManagerModal:
- Add "Add Tag" button that opens inline form with tag input and muscle group dropdown
- Dropdown should contain canonical groups from MUSCLE_GROUPS constant
- Click on existing tag should open edit form with current values
- Delete button with confirmation on each tag
- Save updates via MuscleTagService.saveTags()
- Refresh list after add/edit/delete operations

## 2026-02-02 - US-008: Add tag CRUD operations to modal

**Status:** COMPLETE

**Summary:**
Added full CRUD (Create, Read, Update, Delete) operations to MuscleTagManagerModal. Users can now add new muscle tags, edit existing ones, and delete tags with confirmation.

**Key changes:**
1. `app/constants/muscles.constants.ts`:
   - Added `CANONICAL_MUSCLE_GROUPS` array with all 14 canonical muscle groups
   - Added `CanonicalMuscleGroup` type
   - Updated `MUSCLES` export to include `CANONICAL_GROUPS`

2. `app/constants/ui.constants.ts`:
   - Added modal labels: `ADD_TAG`, `EDIT_TAG`, `NEW_TAG`, `SAVE`, `DELETE`
   - Added placeholder: `ENTER_TAG_NAME`
   - Added notices: `MUSCLE_TAG_SAVED`, `MUSCLE_TAG_DELETED`, `MUSCLE_TAG_DELETE_CONFIRM`, `MUSCLE_TAG_SAVE_ERROR`, `MUSCLE_TAG_EXISTS`

3. `app/features/modals/MuscleTagManagerModal.ts` - Complete rewrite with CRUD:
   - Added "Add tag" button in header section
   - Inline form with tag input + muscle group dropdown (14 canonical groups)
   - Tag input disabled when editing (tag is the key)
   - Click on tag row opens edit form with current values
   - Delete button with ConfirmModal confirmation
   - Save calls `MuscleTagService.saveTags()` and refreshes list
   - Search state preserved across CRUD operations
   - Validation for empty fields and duplicate tags

**Form behavior:**
- Adding: Tag input enabled, focus on tag input
- Editing: Tag input disabled (read-only), focus on muscle group dropdown
- Cancel: Hides form, clears editing state
- Save: Validates, updates Map, saves to CSV, shows success notice

**Next priority:** US-009 (Add fuzzy matching suggestions when adding tags)

**Note for next developer:**
For US-009, you need to add fuzzy matching suggestions to the tag add form:
- When typing a new tag, show similar existing tags using `findSimilarStrings` from StringUtils
- Use Levenshtein distance <= 2 for similarity
- Display suggestions with their muscle group
- Click on suggestion should populate the form for editing that tag
- Show warning icon if new tag is very similar to existing (possible duplicate)
- Debounce the suggestions as user types

## 2026-02-02 - US-009: Add fuzzy matching suggestions when adding tags

**Status:** COMPLETE

**Summary:**
Added fuzzy matching suggestions to the tag add form. When typing a new tag, similar existing tags are shown based on Levenshtein distance, with warning icons for potential duplicates.

**Key changes:**
1. `app/features/modals/MuscleTagManagerModal.ts`:
   - Added import for `StringUtils` for Levenshtein distance calculation
   - Added constants: `FUZZY_MAX_DISTANCE=2`, `FUZZY_WARNING_DISTANCE=1`, `DEBOUNCE_DELAY=150`
   - Added instance properties: `suggestionsContainer`, `debounceTimeout`
   - Added `handleTagInputChange()` - debounced input handler
   - Added `updateSuggestions()` - finds and renders similar tags
   - Added `findSimilarTagsWithDistance()` - returns tags with their distance, sorted
   - Added suggestions container in form (only visible in add mode)
   - Updated `hideForm()` and `onClose()` to clean up debounce timeout

2. `app/constants/ui.constants.ts`:
   - Added `MUSCLE_TAG_SIMILAR_WARNING` - tooltip text for warning icon
   - Added `MUSCLE_TAG_SIMILAR_FOUND(count)` - suggestions count message
   - Added `SIMILAR_TAGS` label for suggestions header

3. `app/styles/modal/_tag-manager.scss` (new file):
   - Full styles for tag manager modal including suggestions
   - `.workout-tag-suggestions` container with header and list
   - `.workout-tag-suggestion-item` with hover states
   - `.workout-tag-suggestion-warning` for very similar tags (yellow background)
   - Warning icon styling

4. `app/styles/modal/_index.scss`:
   - Added `@forward "tag-manager"` to include new styles

**Behavior:**
- Suggestions only show in add mode (not edit mode)
- Minimum 2 characters required before suggestions appear
- Levenshtein distance <= 2 shows as suggestion
- Distance <= 1 shows warning icon (⚠️) with "Similar tag exists" tooltip
- Clicking a suggestion opens edit form for that existing tag
- 150ms debounce prevents excessive computation while typing
- Exact matches are filtered out (handled by "already exists" validation)

**Next priority:** US-010 (Add export functionality to modal)

**Note for next developer:**
For US-010, you need to add an "Export" button to the modal that downloads the current tags as a CSV file. The format should match muscle-tags.csv (tag,muscleGroup columns). Use Blob + URL.createObjectURL for browser download. Filename: muscle-tags-export.csv.

## 2026-02-02 - US-010: Add export functionality to modal

**Status:** COMPLETE

**Summary:**
Added export functionality to MuscleTagManagerModal. Users can now export their muscle tags as a CSV file for backup purposes.

**Key changes:**
1. `app/constants/ui.constants.ts`:
   - Added `MODAL_UI.LABELS.EXPORT_TAGS` - button label
   - Added `MODAL_UI.NOTICES.MUSCLE_TAG_EXPORTED` - success notice
   - Added `MODAL_UI.NOTICES.MUSCLE_TAG_EXPORT_ERROR(error)` - error notice function

2. `app/features/modals/MuscleTagManagerModal.ts`:
   - Added button container in header section (`workout-tag-header-buttons`) to group Add and Export buttons
   - Added Export button with click handler
   - Added `handleExport()` method - generates CSV and triggers browser download
   - Added `escapeCsvValue()` helper method - properly escapes CSV values with commas, quotes, or newlines

**Export behavior:**
- Generates CSV with header row: `tag,muscleGroup`
- Tags are sorted alphabetically for consistency
- Values containing commas, quotes, or newlines are properly escaped per CSV spec
- Uses Blob + URL.createObjectURL for browser download
- Filename: `muscle-tags-export.csv`
- Shows success notice on completion, error notice on failure

**Next priority:** US-011 (Add import functionality to modal)

**Note for next developer:**
For US-011, you need to add an "Import" button that opens a file picker for CSV files. Key requirements:
- Validate CSV format (must have tag,muscleGroup columns)
- Validate muscleGroup values are canonical (from CANONICAL_MUSCLE_GROUPS)
- Show preview of tags to import with count
- Offer "Merge" (add new only) or "Replace" (overwrite all) options
- Update CSV and refresh list after import
Consider using an `<input type="file" accept=".csv">` hidden element triggered by button click.

## 2026-02-02 - US-011: Add import functionality to modal

**Status:** COMPLETE

**Summary:**
Added import functionality to MuscleTagManagerModal. Users can now import muscle tags from a CSV file with validation and preview.

**Key changes:**
1. `app/constants/ui.constants.ts`:
   - Added `MODAL_UI.LABELS.IMPORT_TAGS` - button label
   - Added `MODAL_UI.LABELS.IMPORT_MERGE` - merge button label
   - Added `MODAL_UI.LABELS.IMPORT_REPLACE` - replace all button label
   - (Import-related notices were already present from earlier planning)

2. `app/features/modals/MuscleTagManagerModal.ts`:
   - Added `importPreviewContainer` and `pendingImportTags` properties
   - Added Import button in header section next to Export
   - Added hidden file input (`<input type="file" accept=".csv">`) triggered by button click
   - Added `handleFileSelect()` - reads file using FileReader
   - Added `processImportFile()` - parses CSV, validates format and muscle groups
   - Added `parseCsvLine()` - handles quoted CSV values properly
   - Added `showImportPreview()` - displays preview table with first 10 tags, error summary, merge/replace buttons
   - Added `hideImportPreview()` - clears preview state
   - Added `executeImport()` - performs merge (add new only) or replace (overwrite all) operation

**CSV validation:**
- Checks for 'tag' and 'muscleGroup' columns in header
- Accepts flexible header names: 'muscleGroup', 'muscle_group', 'group'
- Validates each muscle group against CANONICAL_MUSCLE_GROUPS
- Collects and displays errors for invalid muscle groups
- Shows first 3 errors with "...and X more" for remaining

**Import modes:**
- Merge: Adds only new tags, keeps existing tags unchanged
- Replace: Overwrites all existing tags with imported ones

**Next priority:** US-012 (Register command to open tag manager modal)

**Note for next developer:**
For US-012, register a command 'Workout: Manage muscle tags' in CommandHandlerService that opens MuscleTagManagerModal. The modal is already complete with all CRUD operations, import/export functionality. Just need to add the command registration to make it accessible from the command palette.

## 2026-02-02 - US-012: Register command to open tag manager modal

**Status:** COMPLETE

**Summary:**
Registered a new command 'Workout: Manage muscle tags' that opens the MuscleTagManagerModal from the command palette.

**Key changes:**
1. `app/constants/ui.constants.ts`:
   - Added `COMMANDS_UI.MANAGE_MUSCLE_TAGS` - "Manage muscle tags"

2. `app/services/CommandHandlerService.ts`:
   - Added import for `MuscleTagManagerModal`
   - Registered command with id `manage-muscle-tags`
   - Command opens `MuscleTagManagerModal(this.app, this.plugin).open()`

**Verification:**
- `npm run typecheck` passes
- `npm run test` passes (558 tests)

**Next priority:** US-013 (Final validation and integration testing)

**Note for next developer:**
For US-013, run full integration testing:
- Verify adding custom tag in modal makes it available in heatmap filters
- Verify tags persist after Obsidian restart
- Test default tags work when CSV doesn't exist
- Test fuzzy matching prevents obvious duplicates
- Test import/export roundtrip preserves all tags
- Run npm run lint, npm test, npm run build

