# Ralph Progress Log

## 2026-01-24 - US-001: Add TimerPresetConfig type and settings field

**Status:** Completed

**Changes made:**
1. Added `TimerPresetConfig` interface to `app/types/TimerTypes.ts` with fields:
   - `name: string`
   - `type: TIMER_TYPE`
   - `duration: number`
   - `showControls: boolean`
   - `autoStart: boolean`
   - `sound: boolean`
   - `intervalTime?: number` (optional, for interval timers)
   - `rounds?: number` (optional, for interval timers)

2. Exported `TimerPresetConfig` from `app/types/index.ts`

3. Updated `WorkoutChartsSettings` in `app/types/WorkoutLogData.ts` with:
   - `timerPresets: Record<string, TimerPresetConfig>`
   - `defaultTimerPreset: string | null`

4. Updated `DEFAULT_SETTINGS` in `app/types/WorkoutLogData.ts` with:
   - `timerPresets: {}`
   - `defaultTimerPreset: null`

**Notes for next developer:**
- TypeScript compilation passes
- Pre-existing test failures unrelated to this change:
  - `FrontmatterParser.test.ts` - Obsidian module mock configuration issue
  - `FormField.test.ts` - Expects "Exercise Name" but code uses sentence case "Exercise name"
- Next task is US-002: Add Timer Presets UI to settings tab

## 2026-01-24 - US-002: Add Timer Presets UI to settings tab

**Status:** Completed

**Changes made:**
1. Updated `app/constants/Constants.ts` with new settings labels, descriptions, buttons, and messages for timer presets:
   - Labels: TIMER_PRESETS, DEFAULT_TIMER_PRESET, PRESET_NAME, PRESET_TYPE, PRESET_DURATION, etc.
   - Descriptions: TIMER_PRESETS, DEFAULT_TIMER_PRESET, NO_PRESETS
   - Sections: TIMER_PRESETS
   - Buttons: ADD_PRESET, DELETE_PRESET, SAVE_PRESET, CANCEL
   - Messages: PRESET_NAME_REQUIRED, PRESET_NAME_EXISTS, PRESET_DELETED, PRESET_SAVED, CONFIRM_DELETE_PRESET

2. Completely rewrote `app/features/settings/WorkoutChartsSettings.ts` to include Timer Presets UI:
   - Added `renderTimerPresetsSection()` method with section heading
   - Added Default Timer Preset dropdown with "None" option + all existing presets
   - Added `renderPresetsList()` to display all configured presets with edit/delete buttons
   - Added `renderPresetItem()` to display individual preset with formatted details
   - Added `formatPresetDetails()` to format preset config as readable string
   - Added `showPresetEditor()` for inline preset editing (supports both create and edit)
   - Added `savePreset()` with name validation and duplicate checking
   - Added `deletePreset()` with cleanup of default preset reference if needed
   - Editor conditionally shows interval-specific fields (intervalTime, rounds) only for interval timer type

**Features implemented:**
- Settings tab includes 'Timer Presets' section
- Can add a new preset with name input and all configuration fields
- Can edit existing presets inline (clicking pencil icon)
- Can delete presets with confirmation dialog
- Default Timer Preset dropdown shows available presets plus 'None' option
- Presets persist across plugin reloads via plugin.saveSettings()
- Dynamic form that shows/hides interval-specific fields based on timer type

**Notes for next developer:**
- TypeScript compilation passes
- Pre-existing test failures remain (unrelated to this change)
- Next task is US-003: Add preset parameter to workout-timer blocks

## 2026-01-24 - US-003: Add preset parameter to workout-timer blocks

**Status:** Completed

**Changes made:**
1. Updated `app/types/TimerTypes.ts`:
   - Added optional `preset?: string` parameter to `EmbeddedTimerParams` interface

2. Updated `app/views/EmbeddedTimerView.ts`:
   - Added import for `TimerPresetConfig`
   - Added `resolveTimerParams()` method that implements parameter resolution:
     - Checks for explicitly specified preset in code block params
     - Falls back to default preset from settings if no explicit preset
     - Merges preset params with explicit params (explicit override preset)
   - Added `presetToParams()` helper to convert TimerPresetConfig to EmbeddedTimerParams
   - Added `filterUndefined()` helper for proper parameter merging
   - Added `renderPresetError()` to display error when preset not found
   - Updated `createTimer()` to use resolved parameters

**Resolution order implemented:**
1. Explicit parameters from code block
2. Parameters from specified preset (if preset parameter provided)
3. Parameters from default preset (if configured in settings)
4. Hardcoded defaults (TIMER_TYPE.COUNTDOWN, 300 seconds, etc.)

**Usage example:**
```
workout-timer
preset: My Rest Timer
duration: 60
```
This will use "My Rest Timer" preset as base, but override duration to 60 seconds.

**Notes for next developer:**
- TypeScript compilation passes
- Pre-existing test failures remain (unrelated to this change):
  - `FrontmatterParser.test.ts` - Obsidian module mock configuration issue
  - `FormField.test.ts` - Expects "Exercise Name" but code uses sentence case "Exercise name"
- Next task is US-004: Change DEFAULT_EXACT_MATCH to true

## 2026-01-24 - US-004: Change DEFAULT_EXACT_MATCH to true

**Status:** Completed

**Changes made:**
1. Updated `app/constants/Constants.ts`:
   - Added `CONSTANTS.WORKOUT.TABLE.DEFAULTS.EXACT_MATCH = true`
   - Added `CONSTANTS.WORKOUT.SETTINGS.LABELS.DEFAULT_EXACT_MATCH`
   - Added `CONSTANTS.WORKOUT.SETTINGS.DESCRIPTIONS.DEFAULT_EXACT_MATCH`
   - Added `CONSTANTS.WORKOUT.SETTINGS.SECTIONS.FILTERING`

2. Updated `app/types/WorkoutLogData.ts`:
   - Added `defaultExactMatch: boolean` field to `WorkoutChartsSettings` interface
   - Added `defaultExactMatch: true` to `DEFAULT_SETTINGS`

3. Updated `app/features/settings/WorkoutChartsSettings.ts`:
   - Added new "Filtering" section with toggle for "Default exact match" setting
   - Toggle saves to `plugin.settings.defaultExactMatch`

4. Updated `app/features/modals/InsertChartModal.ts`:
   - Changed `exactMatchToggle.checked = true` to use `plugin.settings.defaultExactMatch`

5. Updated `app/features/modals/InsertTableModal.ts`:
   - Changed `exactMatchToggle.checked = true` to use `plugin.settings.defaultExactMatch`

6. Updated `app/features/tables/business/TableConfig.ts`:
   - Changed `exactMatch: false` to `exactMatch: CONSTANTS.WORKOUT.TABLE.DEFAULTS.EXACT_MATCH`

**Features implemented:**
- exactMatch defaults to `true` across the codebase
- New "Filtering" section in settings with "Default exact match" toggle
- Modals use the setting value for their default checkbox state
- Existing code blocks with explicit `exactMatch: false` continue to work unchanged

**Notes for next developer:**
- TypeScript compilation passes
- Pre-existing test failures remain (unrelated to this change):
  - `FrontmatterParser.test.ts` - Obsidian module mock configuration issue
  - `FormField.test.ts` - Expects "Exercise Name" but code uses sentence case "Exercise name"
- Next task is US-005: Create Audit Exercise Names command and modal

## 2026-01-24 - US-005: Create Audit Exercise Names command and modal

**Status:** Completed

**Changes made:**
1. Created `app/features/modals/AuditExerciseNamesModal.ts`:
   - Extends `ModalBase` for consistent modal behavior
   - `scanExerciseFiles()` method scans exercise folder and compares filenames against CSV exercise names
   - Uses existing `getMatchScore()` utility from `app/utils/utils.ts` for fuzzy matching (0-100 similarity scores)
   - `renderResults()` displays results in a table with columns: File name, CSV exercise, Similarity, Status
   - File names are clickable links that open the exercise file
   - Results sorted by score (worst matches first)
   - Shows success message when no mismatches found

2. Updated `app/constants/Constants.ts`:
   - Added `COMMANDS.AUDIT_EXERCISE_NAMES: "Audit exercise names"`
   - Added `MODAL.TITLES.AUDIT_EXERCISE_NAMES: "Audit exercise names"`
   - Added `MODAL.LABELS.FILE_NAME`, `CSV_EXERCISE`, `SIMILARITY`, `STATUS`
   - Added `MODAL.NOTICES.AUDIT_NO_MISMATCHES` and `AUDIT_SCANNING`

3. Updated `app/services/CommandHandlerService.ts`:
   - Imported `AuditExerciseNamesModal`
   - Registered `audit-exercise-names` command that opens the modal

4. Updated `app/styles/_modal.scss`:
   - Added `.workout-audit-success` styling for success message
   - Added `.workout-audit-table-container` with max-height and scrolling
   - Added `.workout-audit-table` with sticky header, hover effects, and cell styling
   - Added `.workout-audit-status-green/yellow/red` for color-coded status indicators

5. Rebuilt CSS from SCSS using `node build-css.mjs`

**Features implemented:**
- Command "Audit exercise names" available in command palette
- Modal scans exercise folder for .md files and compares against CSV exercise names
- Fuzzy matching with similarity scores (0-100%)
- Color-coded status: red (no match/0%), yellow (partial/close match/1-99%), green (exact match/100%)
- Clickable file names open the exercise file
- Results sorted by score (worst matches first)
- Success message when no mismatches found

**Notes for next developer:**
- TypeScript compilation passes
- Pre-existing test failures remain (unrelated to this change):
  - `FrontmatterParser.test.ts` - Obsidian module mock configuration issue
  - `FormField.test.ts` - Expects "Exercise Name" but code uses sentence case "Exercise name"
- Next task is US-006: Add renameExercise method to DataService
## 2026-01-24 - US-006: Add renameExercise method to DataService

**Status:** Completed

**Changes made:**
1. Added `renameExercise(oldName: string, newName: string): Promise<number>` method to DataService in `app/services/DataService.ts`

**Implementation details:**
- Method reads CSV file using existing `parseCSVLogFile` utility
- Normalizes exercise names for comparison (case-insensitive, trimmed whitespace)
- Updates all matching entries in the CSV to the new exercise name
- Writes back to CSV using existing `entriesToCSVContent` utility
- Clears cache via `clearLogDataCache()` to ensure changes are reflected immediately
- Returns count of updated entries for feedback
- Wraps operations in try-catch with descriptive error messages

**Method signature:**
```typescript
public async renameExercise(
  oldName: string,
  newName: string,
): Promise<number>
```

**Error handling:**
- Throws error if CSV file not found (reuses existing CONSTANTS.WORKOUT.MESSAGES.ERRORS.CSV_NOT_FOUND)
- Catches and wraps any processing errors with descriptive message
- Uses Obsidian's vault.process() API for atomic file updates

**Notes for next developer:**
- TypeScript compilation passes
- Pre-existing test failures remain (unrelated to this change):
  - `FrontmatterParser.test.ts` - Obsidian module mock configuration issue
  - `FormField.test.ts` - Expects "Exercise Name" but code uses sentence case "Exercise name"
- Next task is US-007: Add Rename in CSV button to Audit Modal
- This method is foundational for the audit modal's rename functionality

## 2026-01-24 - US-007: Add Rename in CSV button to Audit Modal

**Status:** Completed

**Changes made:**
1. Updated `app/constants/Constants.ts`:
   - Added `MODAL.BUTTONS.RENAME_IN_CSV: "Rename in CSV"`
   - Added `MODAL.BUTTONS.RENAME_FILE: "Rename file"`
   - Added `MODAL.NOTICES.AUDIT_RENAME_SUCCESS: "Successfully renamed exercise in CSV"`
   - Added `MODAL.NOTICES.AUDIT_RENAME_ERROR: "Error renaming exercise: "`
   - Added `MODAL.NOTICES.AUDIT_CONFIRM_RENAME: "Are you sure you want to rename this exercise in the CSV?"`

2. Updated `main.ts`:
   - Added public method `renameExercise(oldName: string, newName: string): Promise<number>`
   - Method wraps `dataService.renameExercise()` to expose functionality to modals
   - Follows same pattern as other public methods (deleteWorkoutLogEntry, updateWorkoutLogEntry, etc.)

3. Updated `app/features/modals/AuditExerciseNamesModal.ts`:
   - Added "Actions" column header to audit results table
   - Added "Rename in CSV" button to each mismatch row (only shown for valid matches with score > 0)
   - Added `handleRenameInCSV()` method that:
     - Shows confirmation dialog with "oldName → newName" preview using browser's confirm()
     - Calls `plugin.renameExercise()` to update CSV
     - Displays success message with count of updated entries (e.g., "Successfully renamed exercise in CSV (3 entries updated)")
     - Refreshes modal automatically by calling `scanExerciseFiles()` and `renderResults()`
     - Handles errors gracefully with error notices

**Features implemented:**
- "Rename in CSV" button appears in Actions column for each mismatch with a valid match (score > 0)
- Confirmation dialog shows clear preview: "oldName" → "newName"
- Success message indicates how many CSV entries were updated
- Modal refreshes automatically after rename to show updated audit results
- Button only appears when there's a valid match to rename to (not for "No match found" entries)
- Error handling with user-friendly error messages

**Notes for next developer:**
- TypeScript compilation passes
- Pre-existing test failures remain (unrelated to this change):
  - `FrontmatterParser.test.ts` - Obsidian module mock configuration issue
  - `FormField.test.ts` - Expects "Exercise Name" but code uses sentence case "Exercise name"
- Next task is US-008: Add Rename File button to Audit Modal
- The rename functionality integrates seamlessly with the existing audit modal UI

## 2026-01-24 - US-008: Add Rename File button to Audit Modal

**Status:** Completed

**Changes made:**
1. Updated `app/constants/Constants.ts`:
   - Added `MODAL.NOTICES.AUDIT_RENAME_FILE_SUCCESS: "Successfully renamed exercise file"`
   - Added `MODAL.NOTICES.AUDIT_RENAME_FILE_ERROR: "Error renaming file: "`
   - Added `MODAL.NOTICES.AUDIT_CONFIRM_RENAME_FILE: "Are you sure you want to rename this file?"`

2. Updated `app/features/modals/AuditExerciseNamesModal.ts`:
   - Modified Actions column to use flexbox layout with 8px gap for button spacing
   - Added "Rename File" button next to "Rename in CSV" button in each mismatch row
   - Both buttons only appear when there's a valid match to rename to (score > 0)
   - Added `handleRenameFile()` method that:
     - Shows confirmation dialog with "oldFileName.md → newFileName.md" preview using browser's confirm()
     - Calculates new file path by replacing old filename with CSV exercise name
     - Uses `app.vault.rename()` API to rename the exercise file
     - Displays success message on completion
     - Refreshes modal automatically by calling `scanExerciseFiles()` and `renderResults()`
     - Handles errors gracefully with error notices

**Features implemented:**
- "Rename File" button appears in Actions column for each mismatch with a valid match (score > 0)
- Confirmation dialog shows clear preview: "oldFileName.md" → "newFileName.md"
- Uses Obsidian's vault.rename() API for file operations
- Success/error messages guide the user through the operation
- Modal refreshes automatically after rename to show updated audit results
- Button only appears when there's a valid match (not for "No match found" entries)
- Both rename buttons (CSV and File) are displayed side-by-side with proper spacing

**Notes for next developer:**
- TypeScript compilation passes
- Pre-existing test failures remain (unrelated to this change):
  - `FrontmatterParser.test.ts` - Obsidian module mock configuration issue
  - `FormField.test.ts` - Expects "Exercise Name" but code uses sentence case "Exercise name"
- All user stories in the PRD are now complete
- The audit modal now provides comprehensive bidirectional rename functionality: rename CSV to match files OR rename files to match CSV

## 2026-01-24 - Phase 2 Core Features - US-001: Configure Exercise Block Template in Settings

**Status:** Completed

**Changes made:**
1. Updated `app/types/WorkoutLogData.ts`:
   - Added `exerciseBlockTemplate: string` field to `WorkoutChartsSettings` interface
   - Added default template to `DEFAULT_SETTINGS` with placeholders: {{exercise}}, {{duration}}, {{workout}}, {{preset}}
   - Default template includes markdown heading, workout-timer code block, and workout-log code block

2. Updated `app/constants/Constants.ts`:
   - Added `SETTINGS.LABELS.EXERCISE_BLOCK_TEMPLATE: "Exercise block template"`
   - Added `SETTINGS.DESCRIPTIONS.EXERCISE_BLOCK_TEMPLATE` with placeholder documentation
   - Added `SETTINGS.SECTIONS.TEMPLATES: "Templates"`

3. Updated `app/features/settings/WorkoutChartsSettings.ts`:
   - Added `renderTemplatesSection()` method to display Templates section
   - Added textarea setting for exercise block template with 10 rows, 50 cols
   - Template persists via plugin.saveSettings() on change

**Features implemented:**
- New "Templates" section in settings tab
- Exercise Block Template textarea with default template pre-filled
- Description shows available placeholders: {{exercise}}, {{duration}}, {{workout}}, {{preset}}
- Template persists across plugin reloads via settings

**Notes for next developer:**
- TypeScript compilation passes (`npm run build`)
- Pre-existing test failures remain (unrelated to this change):
  - `FrontmatterParser.test.ts` - Obsidian module mock configuration issue
  - `FormField.test.ts` - Expects "Exercise Name" but code uses sentence case "Exercise name"
- Next task is US-002: Add Exercise Block Command with Modal
- The template is now configurable but not yet used - US-002 will implement the command to insert exercise blocks using this template

## 2026-01-24 - Phase 2 Core Features - US-002: Add Exercise Block Command with Modal

**Status:** Completed

**Changes made:**
1. Updated `app/constants/Constants.ts`:
   - Added `COMMANDS.ADD_EXERCISE_BLOCK: "Add exercise block"`
   - Added `MODAL.TITLES.ADD_EXERCISE_BLOCK: "Add exercise block"`
   - Added `MODAL.BUTTONS.INSERT_EXERCISE_BLOCK: "Insert"`
   - Added `MODAL.NOTICES.EXERCISE_BLOCK_INSERTED: "✅ Exercise block inserted successfully!"`
   - Added `MODAL.LABELS.TIMER_DURATION: "Timer duration (seconds):"`
   - Added `MODAL.LABELS.TIMER_PRESET: "Timer preset:"`
   - Added `MODAL.LABELS.WORKOUT_FILE: "Workout file:"`

2. Created `app/features/modals/AddExerciseBlockModal.ts`:
   - Extends `BaseInsertModal` for consistent modal behavior
   - Implements `ExerciseAutocomplete` component for exercise name input with autocomplete
   - Includes timer preset dropdown (only shown if presets exist in settings)
   - Sets default timer preset from settings if configured
   - Includes timer duration input (default 90 seconds)
   - Includes workout file selector that defaults to current file
   - `generateCode()` method parses template from `plugin.settings.exerciseBlockTemplate`
   - Replaces all placeholders: {{exercise}}, {{duration}}, {{workout}}, {{preset}}
   - Validates exercise name is provided before generating code

3. Updated `app/services/CommandHandlerService.ts`:
   - Imported `AddExerciseBlockModal`
   - Registered `add-exercise-block` command that opens the modal

**Features implemented:**
- Command "Add exercise block" available in command palette
- Modal with three sections: Exercise, Timer, Workout
- Exercise section uses ExerciseAutocomplete for smart exercise selection
- Timer section shows preset dropdown (if presets exist) with default preset pre-selected
- Timer section includes duration input field
- Workout section has file selector defaulting to current file
- Insert button parses template from settings and replaces placeholders
- Template placeholders support: {{exercise}}, {{duration}}, {{workout}}, {{preset}}
- Validation ensures exercise name is provided

**Notes for next developer:**
- TypeScript compilation passes (`npm run build`)
- Pre-existing test failures remain (unrelated to this change):
  - `FrontmatterParser.test.ts` - Obsidian module mock configuration issue
  - `FormField.test.ts` - Expects "Exercise Name" but code uses sentence case "Exercise name"
- Next task is US-003: Add targetWeight and targetReps parameters to workout-log
- The exercise block template is fully functional and can be customized in settings
- The modal follows the same pattern as other insert modals (InsertTimerModal, InsertChartModal)

## 2026-01-24 - Phase 2 Core Features - US-003: Add targetWeight and targetReps parameters to workout-log

**Status:** Completed

**Changes made:**
1. Updated `app/types/TableTypes.ts`:
   - Added `targetWeight?: number` optional parameter to `EmbeddedTableParams` interface
   - Added `targetReps?: number` optional parameter to `EmbeddedTableParams` interface

2. Updated `app/types/WorkoutLogData.ts`:
   - Added `weightIncrement: number` field to `WorkoutChartsSettings` interface
   - Added `weightIncrement: 2.5` to `DEFAULT_SETTINGS` (2.5kg default increment)

3. Updated `app/constants/Constants.ts`:
   - Added `SETTINGS.LABELS.WEIGHT_INCREMENT: "Weight increment (kg)"`
   - Added `SETTINGS.DESCRIPTIONS.WEIGHT_INCREMENT` with explanation of progressive overload
   - Added `SETTINGS.SECTIONS.PROGRESSIVE_OVERLOAD: "Progressive overload"`

4. Updated `app/features/settings/WorkoutChartsSettings.ts`:
   - Added `renderProgressiveOverloadSection()` method to display Progressive Overload section
   - Added text input for weight increment with validation (must be positive number)
   - Setting persists via plugin.saveSettings() on change
   - Section added after Templates section in settings display

**Parameter parsing:**
- Parameters are automatically parsed by existing `parseCodeBlockParams()` method in `CodeBlockProcessorService`
- Method already handles number parsing, so `targetWeight` and `targetReps` are correctly parsed as numbers
- No changes needed to parsing logic - it just works!

**Usage example:**
```
workout-log
exercise: Bench Press
targetWeight: 100
targetReps: 5
```

**Notes for next developer:**
- TypeScript compilation passes (`npm run build`)
- Pre-existing test failures remain (unrelated to this change):
  - `FrontmatterParser.test.ts` - Obsidian module mock configuration issue
  - `FormField.test.ts` - Expects "Exercise Name" but code uses sentence case "Exercise name"
- Next task is US-004: Display target header in workout log
- The parameters are now available in `EmbeddedTableParams` and ready to be used for displaying target information
- The weightIncrement setting is available in `plugin.settings.weightIncrement` for future progression calculations

## 2026-01-24 - Phase 2 Core Features - US-004: Display target header in workout log

**Status:** Completed

**Changes made:**
1. Updated `app/constants/Constants.ts`:
   - Added `TARGET_PREFIX: "Target:"` to `CONSTANTS.WORKOUT.LABELS.TABLE`

2. Updated `app/views/EmbeddedTableView.ts`:
   - Added `renderTargetHeader()` private method to render target header when targetWeight or targetReps is set
   - Method renders a div with class `workout-target-header` containing formatted target text
   - Header format: "Target: {weight}kg × {reps} reps" (or partial if only one is set)
   - Header is rendered between Add Log button and table container in `renderTableContentOptimized()`
   - Only renders when at least one of targetWeight or targetReps is defined

3. Updated `app/styles/_table.scss`:
   - Added `.workout-target-header` styling with:
     - Padding and margins for spacing
     - Subtle background color using `var(--background-secondary)`
     - Border-left accent using `var(--text-accent)`
     - Centered text with medium font weight
     - Border radius for rounded corners
   - Built CSS from SCSS using `node build-css.mjs`

**Features implemented:**
- Target header displays when targetWeight or targetReps parameters are set in workout-log code blocks
- Header format shows weight and/or reps in clear, readable format
- Header styled with Obsidian CSS variables for theme consistency
- Header positioned between exercise name (Add Log button) and table
- Supports partial display (weight only, reps only, or both)

**Usage example:**
```
workout-log
exercise: Bench Press
targetWeight: 100
targetReps: 5
```
This will display: "Target: 100kg × 5 reps" above the workout log table.

**Notes for next developer:**
- TypeScript compilation passes (`npm run build`)
- Pre-existing test failures remain (unrelated to this change):
  - `FrontmatterParser.test.ts` - Obsidian module mock configuration issue
  - `FormField.test.ts` - Expects "Exercise Name" but code uses sentence case "Exercise name"
- Next task is US-005: Display target progress indicator
- The target header is now displayed, ready for US-005 to add progress bar visualization

